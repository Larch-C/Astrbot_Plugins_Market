name: Update Plugin Cache
on:
  schedule:
    # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 * * * *'  # ä¿®å¤äº†cronè¡¨è¾¾å¼
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# æ·»åŠ æƒé™å£°æ˜
permissions:
  contents: write
  actions: read

jobs:
  update-cache:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
    
    - name: Fetch plugin data
      id: fetch-data
      run: |
        echo "å¼€å§‹è·å–æ’ä»¶æ•°æ®..."
        
        # è®¾ç½®è¶…æ—¶å’Œé‡è¯•
        response=$(curl -s --max-time 30 --retry 3 --retry-delay 5 \
          -H "User-Agent: GitHub-Action-Plugin-Cache" \
          "https://api.soulter.top/astrbot/plugins")
        
        # æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºç©º
        if [ -z "$response" ]; then
          echo "è·å–åˆ°çš„å“åº”ä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSON
        if ! echo "$response" | jq . > /dev/null 2>&1; then
          echo "å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ£€æŸ¥JSONæ˜¯å¦ä¸ºç©ºå¯¹è±¡æˆ–ç©ºæ•°ç»„
        if [ "$response" = "{}" ] || [ "$response" = "[]" ] || [ "$response" = "null" ]; then
          echo "è·å–åˆ°ç©ºçš„JSONæ•°æ®ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # ä¿å­˜å“åº”åˆ°ä¸´æ—¶æ–‡ä»¶
        echo "$response" > temp_plugin_cache.json
        echo "should_update=true" >> $GITHUB_OUTPUT
        echo "æˆåŠŸè·å–æ’ä»¶æ•°æ®"
    
    - name: Update plugin cache
      if: steps.fetch-data.outputs.should_update == 'true'
      run: |
        echo "=== è°ƒè¯•ä¿¡æ¯ï¼šæ›´æ–°å‰ ==="
        echo "ä¸´æ—¶æ–‡ä»¶å¤§å°: $(wc -c < temp_plugin_cache.json) bytes"
        echo "ä¸´æ—¶æ–‡ä»¶å‰100å­—ç¬¦: $(head -c 100 temp_plugin_cache.json)"
        
        if [ -f plugin_cache.json ]; then
          echo "åŸæ–‡ä»¶å¤§å°: $(wc -c < plugin_cache.json) bytes"
          echo "åŸæ–‡ä»¶å‰100å­—ç¬¦: $(head -c 100 plugin_cache.json)"
        else
          echo "åŸæ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        # ç§»åŠ¨ä¸´æ—¶æ–‡ä»¶åˆ°ç›®æ ‡ä½ç½®
        mv temp_plugin_cache.json plugin_cache.json
        
        # æ ¼å¼åŒ–JSONï¼ˆå¯é€‰ï¼Œä½¿å…¶æ›´æ˜“è¯»ï¼‰
        if command -v jq &> /dev/null; then
          jq . plugin_cache.json > temp.json && mv temp.json plugin_cache.json
        fi
        
        echo "=== è°ƒè¯•ä¿¡æ¯ï¼šæ›´æ–°å ==="
        echo "æ–°æ–‡ä»¶å¤§å°: $(wc -c < plugin_cache.json) bytes"
        echo "æ–°æ–‡ä»¶å‰100å­—ç¬¦: $(head -c 100 plugin_cache.json)"
        echo "æ’ä»¶ç¼“å­˜æ–‡ä»¶å·²æ›´æ–°"
    
    - name: Check for changes
      if: steps.fetch-data.outputs.should_update == 'true'
      id: git-check
      run: |
        echo "=== æ£€æŸ¥æ–‡ä»¶å˜åŒ– ==="
        
        # æ˜¾ç¤ºå·¥ä½œç›®å½•çŠ¶æ€
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la plugin_cache.json 2>/dev/null || echo "plugin_cache.json æ–‡ä»¶ä¸å­˜åœ¨"
        
        # æ˜¾ç¤ºGitçŠ¶æ€
        echo "GitçŠ¶æ€:"
        git status --porcelain
        git status
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨äºä»“åº“ä¸­
        if git ls-files --error-unmatch plugin_cache.json >/dev/null 2>&1; then
          echo "plugin_cache.json å·²è¢«Gitè·Ÿè¸ªï¼ˆå·²å­˜åœ¨äºä»“åº“ï¼‰"
          # å¯¹äºå·²è·Ÿè¸ªçš„æ–‡ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          if git diff --exit-code plugin_cache.json; then
            echo "å·²è·Ÿè¸ªæ–‡ä»¶æ— å˜åŒ–"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "å·²è·Ÿè¸ªæ–‡ä»¶æœ‰å˜åŒ–"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "plugin_cache.json æœªè¢«Gitè·Ÿè¸ªï¼ˆæ–°æ–‡ä»¶ï¼‰"
          if [ -f plugin_cache.json ]; then
            echo "æ–‡ä»¶å­˜åœ¨ä½†æœªè·Ÿè¸ªï¼Œè¿™æ˜¯ä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œéœ€è¦æäº¤ï¼"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "æ–‡ä»¶ä¸å­˜åœ¨"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        fi
        
        # é¢å¤–ä¿é™©ï¼šæ£€æŸ¥ git status ä¸­æ˜¯å¦æœ‰æœªè·Ÿè¸ªæˆ–ä¿®æ”¹çš„æ–‡ä»¶
        if git status --porcelain | grep -E "^\?\?.*plugin_cache\.json|^.M.*plugin_cache\.json|^M.*plugin_cache\.json"; then
          echo "git status æ˜¾ç¤º plugin_cache.json æœ‰å˜åŒ–ï¼ˆæ–°æ–‡ä»¶æˆ–ä¿®æ”¹ï¼‰"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        
        echo "æœ€ç»ˆå†³å®š has_changes: $(git status --porcelain | grep plugin_cache || echo 'no changes')"
    
    - name: Commit and push changes
      if: steps.fetch-data.outputs.should_update == 'true' && steps.git-check.outputs.has_changes == 'true'
      run: |
        echo "å‡†å¤‡æäº¤å˜æ›´..."
        
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --local user.email "igcrystalcache@gmail.com"
        git config --local user.name "IGCrystal-Ghost"
        
        # å¼ºåˆ¶æ·»åŠ æ–‡ä»¶ï¼ˆç¡®ä¿è¢«è·Ÿè¸ªï¼‰
        git add -f plugin_cache.json
        
        # æ£€æŸ¥æ˜¯å¦çœŸçš„æœ‰å†…å®¹è¦æäº¤
        if git diff --cached --quiet; then
          echo "è­¦å‘Šï¼šæ²¡æœ‰æš‚å­˜çš„æ›´æ”¹ï¼Œä½†æ¡ä»¶åˆ¤æ–­è¯´æœ‰å˜åŒ–"
          git status
          git diff plugin_cache.json
          exit 1
        fi
        
        # æäº¤æ›´æ”¹
        git commit -m "ğŸ”„ Update plugin cache - $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || {
          echo "æäº¤å¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼š"
          git status
          git diff --cached
          exit 1
        }
        
        # æ¨é€åˆ°è¿œç¨‹ä»“åº“
        echo "æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
        git push origin HEAD:${{ github.ref_name }} || {
          echo "æ¨é€å¤±è´¥"
          exit 1
        }
        
        echo "âœ… å·²æˆåŠŸæäº¤å¹¶æ¨é€æ›´æ–°"
    
    - name: Clean up
      if: always()
      run: |
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f temp_plugin_cache.json temp.json
    
    - name: Summary
      if: always()
      run: |
        echo "=== æ‰§è¡Œæ€»ç»“ ==="
        echo "should_update: ${{ steps.fetch-data.outputs.should_update }}"
        echo "has_changes: ${{ steps.git-check.outputs.has_changes }}"
        
        if [ "${{ steps.fetch-data.outputs.should_update }}" = "true" ]; then
          if [ "${{ steps.git-check.outputs.has_changes }}" = "true" ]; then
            echo "âœ… æ’ä»¶ç¼“å­˜å·²æˆåŠŸæ›´æ–°å¹¶æäº¤"
          else
            echo "â„¹ï¸ æ•°æ®è·å–æˆåŠŸï¼Œä½†å†…å®¹æœªå‘ç”Ÿå˜åŒ–ï¼Œæ— éœ€æäº¤"
          fi
        else
          echo "âš ï¸ ç”±äºç½‘ç»œé—®é¢˜æˆ–æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡äº†ç¼“å­˜æ›´æ–°"
        fi
