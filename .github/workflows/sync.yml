name: Update Plugin Cache

on:
  schedule:
    # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-cache:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
    
    - name: Fetch plugin data
      id: fetch-data
      run: |
        echo "å¼€å§‹è·å–æ’ä»¶æ•°æ®..."
        
        # è®¾ç½®è¶…æ—¶å’Œé‡è¯•
        response=$(curl -s --max-time 30 --retry 3 --retry-delay 5 \
          -H "User-Agent: GitHub-Action-Plugin-Cache" \
          "https://api.soulter.top/astrbot/plugins")
        
        # æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºç©º
        if [ -z "$response" ]; then
          echo "è·å–åˆ°çš„å“åº”ä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSON
        if ! echo "$response" | jq . > /dev/null 2>&1; then
          echo "å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ£€æŸ¥JSONæ˜¯å¦ä¸ºç©ºå¯¹è±¡æˆ–ç©ºæ•°ç»„
        if [ "$response" = "{}" ] || [ "$response" = "[]" ] || [ "$response" = "null" ]; then
          echo "è·å–åˆ°ç©ºçš„JSONæ•°æ®ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # ä¿å­˜å“åº”åˆ°ä¸´æ—¶æ–‡ä»¶
        echo "$response" > temp_plugin_cache.json
        echo "should_update=true" >> $GITHUB_OUTPUT
        echo "æˆåŠŸè·å–æ’ä»¶æ•°æ®"
    
    - name: Update plugin cache
      if: steps.fetch-data.outputs.should_update == 'true'
      run: |
        # ç§»åŠ¨ä¸´æ—¶æ–‡ä»¶åˆ°ç›®æ ‡ä½ç½®
        mv temp_plugin_cache.json plugin_cache.json
        
        # æ ¼å¼åŒ–JSONï¼ˆå¯é€‰ï¼Œä½¿å…¶æ›´æ˜“è¯»ï¼‰
        if command -v jq &> /dev/null; then
          jq . plugin_cache.json > temp.json && mv temp.json plugin_cache.json
        fi
        
        echo "æ’ä»¶ç¼“å­˜å·²æ›´æ–°"
    
    - name: Check for changes
      if: steps.fetch-data.outputs.should_update == 'true'
      id: git-check
      run: |
        git diff --exit-code plugin_cache.json || echo "has_changes=true" >> $GITHUB_OUTPUT
    
    - name: Commit and push changes
      if: steps.fetch-data.outputs.should_update == 'true' && steps.git-check.outputs.has_changes == 'true'
      run: |
        git config --local user.email "igcrystalcache@gmail.com"
        git config --local user.name "IGCrystal-Ghost"
        
        git add plugin_cache.json
        git commit -m "ğŸ”„ Update plugin cache - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        git push
        
        echo "å·²æäº¤å¹¶æ¨é€æ›´æ–°åˆ°mainåˆ†æ”¯"
    
    - name: Clean up
      if: always()
      run: |
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f temp_plugin_cache.json temp.json
    
    - name: Summary
      if: always()
      run: |
        if [ "${{ steps.fetch-data.outputs.should_update }}" = "true" ]; then
          if [ "${{ steps.git-check.outputs.has_changes }}" = "true" ]; then
            echo "âœ… æ’ä»¶ç¼“å­˜å·²æˆåŠŸæ›´æ–°å¹¶æäº¤"
          else
            echo "â„¹ï¸ æ•°æ®è·å–æˆåŠŸï¼Œä½†å†…å®¹æœªå‘ç”Ÿå˜åŒ–"
          fi
        else
          echo "âš ï¸ ç”±äºç½‘ç»œé—®é¢˜æˆ–æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡äº†ç¼“å­˜æ›´æ–°"
        fi
