name: Transform Plugin Data

on:
  schedule:
    # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  transform-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
    
    - name: Fetch original plugin data
      id: fetch-data
      run: |
        echo "å¼€å§‹è·å–åŸå§‹æ’ä»¶æ•°æ®..."
        
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨å“åº”å’ŒHTTPçŠ¶æ€ç 
        temp_response="temp_response.txt"
        temp_headers="temp_headers.txt"
        
        # è·å–GitHubåŸå§‹æ–‡ä»¶å†…å®¹
        github_url="https://raw.githubusercontent.com/AstrBotDevs/AstrBot_Plugins_Collection/main/plugins.json"
        
        # ä½¿ç”¨curlè·å–æ•°æ®ï¼ŒåŒæ—¶ä¿å­˜HTTPçŠ¶æ€ç å’Œå“åº”å¤´
        http_code=$(curl -s --max-time 30 --retry 3 --retry-delay 5 \
          -H "User-Agent: GitHub-Action-Plugin-Transformer" \
          -H "Accept: application/json" \
          -w "%{http_code}" \
          -D "$temp_headers" \
          -o "$temp_response" \
          "$github_url")
        
        curl_exit_code=$?
        
        # æ£€æŸ¥curlå‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
        if [ $curl_exit_code -ne 0 ]; then
          echo "âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œcurlé€€å‡ºç : $curl_exit_code"
          case $curl_exit_code in
            6) echo "æ— æ³•è§£æä¸»æœºå" ;;
            7) echo "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨" ;;
            28) echo "è¯·æ±‚è¶…æ—¶" ;;
            35) echo "SSLè¿æ¥é”™è¯¯" ;;
            *) echo "å…¶ä»–ç½‘ç»œé”™è¯¯" ;;
          esac
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        echo "HTTPçŠ¶æ€ç : $http_code"
        
        # æ£€æŸ¥HTTPçŠ¶æ€ç 
        if [ "$http_code" -ne 200 ]; then
          echo "âŒ GitHubè¿”å›é200çŠ¶æ€ç : $http_code"
          case $http_code in
            404) echo "æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä»“åº“ä¸å¯è®¿é—® (404 Not Found)" ;;
            403) echo "è®¿é—®è¢«æ‹’ç»ï¼Œå¯èƒ½æ˜¯APIé™åˆ¶ (403 Forbidden)" ;;
            500) echo "GitHubæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (500 Internal Server Error)" ;;
            *) echo "HTTPé”™è¯¯çŠ¶æ€ç : $http_code" ;;
          esac
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # è¯»å–å“åº”å†…å®¹
        if [ ! -f "$temp_response" ]; then
          echo "âŒ å“åº”æ–‡ä»¶ä¸å­˜åœ¨"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        response=$(cat "$temp_response")
        
        # æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºç©º
        if [ -z "$response" ] || [ "$response" = "" ]; then
          echo "âŒ è·å–åˆ°çš„å“åº”ä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # æ£€æŸ¥å“åº”å¤§å°
        response_size=$(wc -c < "$temp_response")
        if [ "$response_size" -lt 50 ]; then
          echo "âŒ å“åº”å†…å®¹è¿‡å° ($response_size å­—èŠ‚)ï¼Œå¯èƒ½æ˜¯é”™è¯¯å“åº”"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSON
        if ! echo "$response" | jq . > /dev/null 2>&1; then
          echo "âŒ å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # æ£€æŸ¥JSONæ˜¯å¦ä¸ºç©ºå¯¹è±¡æˆ–ç©ºæ•°ç»„
        if [ "$response" = "{}" ] || [ "$response" = "[]" ] || [ "$response" = "null" ]; then
          echo "âŒ è·å–åˆ°ç©ºçš„JSONæ•°æ®ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # ä¿å­˜åŸå§‹æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶
        echo "$response" > original_plugins.json
        echo "should_update=true" >> $GITHUB_OUTPUT
        echo "âœ… æˆåŠŸè·å–åŸå§‹æ’ä»¶æ•°æ® ($response_size å­—èŠ‚)"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f "$temp_response" "$temp_headers"
    
    - name: Get GitHub API info for repositories
      if: steps.fetch-data.outputs.should_update == 'true'
      id: get-repo-info
      run: |
        echo "å¼€å§‹è·å–ä»“åº“ä¿¡æ¯..."
        
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å­˜å‚¨ä»“åº“ä¿¡æ¯
        echo "{}" > repo_info.json
        
        # ä»åŸå§‹æ•°æ®ä¸­æå–æ‰€æœ‰ä»“åº“URL
        jq -r 'to_entries[] | .value.repo // empty' original_plugins.json | while read -r repo_url; do
          # æå–GitHubç”¨æˆ·åå’Œä»“åº“å (æ ¼å¼: https://github.com/user/repo)
          if [[ "$repo_url" =~ https://github\.com/([^/]+)/([^/]+) ]]; then
            owner="${BASH_REMATCH[1]}"
            repo="${BASH_REMATCH[2]}"
            
            echo "è·å–ä»“åº“ä¿¡æ¯: $owner/$repo"
            
            # è°ƒç”¨GitHub APIè·å–ä»“åº“ä¿¡æ¯
            api_response=$(curl -s --max-time 10 \
              -H "Accept: application/vnd.github.v3+json" \
              -H "User-Agent: GitHub-Action-Plugin-Transformer" \
              "https://api.github.com/repos/$owner/$repo" || echo "{}")
            
            # æ£€æŸ¥APIå“åº”æ˜¯å¦æœ‰æ•ˆ
            if echo "$api_response" | jq -e '.stargazers_count' > /dev/null 2>&1; then
              stars=$(echo "$api_response" | jq -r '.stargazers_count // 0')
              updated_at=$(echo "$api_response" | jq -r '.updated_at // ""')
              
              # è·å–æœ€æ–°çš„releaseç‰ˆæœ¬
              release_response=$(curl -s --max-time 10 \
                -H "Accept: application/vnd.github.v3+json" \
                -H "User-Agent: GitHub-Action-Plugin-Transformer" \
                "https://api.github.com/repos/$owner/$repo/releases/latest" || echo "{}")
              
              version=""
              if echo "$release_response" | jq -e '.tag_name' > /dev/null 2>&1; then
                version=$(echo "$release_response" | jq -r '.tag_name')
              fi
              
              # å°†ä¿¡æ¯æ·»åŠ åˆ°repo_info.json
              jq --arg url "$repo_url" --arg stars "$stars" --arg updated "$updated_at" --arg version "$version" \
                '. + {($url): {stars: ($stars | tonumber), updated_at: $updated, version: $version}}' \
                repo_info.json > temp_repo_info.json && mv temp_repo_info.json repo_info.json
            else
              echo "âš ï¸  æ— æ³•è·å– $owner/$repo çš„ä¿¡æ¯"
            fi
            
            # æ·»åŠ å»¶è¿Ÿé¿å…APIé™åˆ¶
            sleep 1
          fi
        done
        
        echo "âœ… ä»“åº“ä¿¡æ¯è·å–å®Œæˆ"
    
    - name: Transform plugin data
      if: steps.fetch-data.outputs.should_update == 'true'
      run: |
        echo "å¼€å§‹è½¬æ¢æ’ä»¶æ•°æ®æ ¼å¼..."
        
        # ä½¿ç”¨jqè½¬æ¢æ•°æ®æ ¼å¼
        jq --slurpfile repo_info repo_info.json '
        {
          data: (
            to_entries | map({
              key: .key,
              value: (
                .value + {
                  # ä¿æŒåŸæœ‰å­—æ®µ
                  desc: .value.desc,
                  author: .value.author,
                  repo: .value.repo,
                  tags: (.value.tags // []),
                  social_link: .value.social_link
                } + 
                # æ·»åŠ æ–°å­—æ®µï¼Œä»repo_infoä¸­è·å–
                (if .value.repo and ($repo_info[0][.value.repo]) then
                  {
                    stars: $repo_info[0][.value.repo].stars,
                    updated_at: $repo_info[0][.value.repo].updated_at,
                    version: (if $repo_info[0][.value.repo].version != "" then $repo_info[0][.value.repo].version else "1.0.0" end)
                  }
                else
                  {
                    version: "1.0.0"
                  }
                end)
              )
            }) | from_entries
          )
        }' original_plugins.json > temp_plugin_cache.json
        
        # æ ¼å¼åŒ–JSONä½¿å…¶æ›´æ˜“è¯»
        jq . temp_plugin_cache.json > plugin_cache_orginal.json
        
        echo "âœ… æ•°æ®è½¬æ¢å®Œæˆ"
        
        # æ˜¾ç¤ºè½¬æ¢ç»Ÿè®¡
        original_count=$(jq 'keys | length' original_plugins.json)
        new_count=$(jq '.data | keys | length' plugin_cache.json)
        echo "è½¬æ¢ç»Ÿè®¡: $original_count ä¸ªæ’ä»¶ -> $new_count ä¸ªæ’ä»¶"
    
    - name: Check for changes
      if: steps.fetch-data.outputs.should_update == 'true'
      id: git-check
      run: |
        if [ -f plugin_cache.json ]; then
          git diff --exit-code plugin_cache.json || echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.fetch-data.outputs.should_update == 'true' && steps.git-check.outputs.has_changes == 'true'
      run: |
        git config --local user.email "igcrystalcache@gmail.com"
        git config --local user.name "IGCrystal-Ghost"
        
        git add plugin_cache.json
        git commit -m "ğŸ”„ Update transformed plugin cache - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        git push
        
        echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ–°åˆ°mainåˆ†æ”¯"
    
    - name: Clean up
      if: always()
      run: |
        # æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
        rm -f temp_plugin_cache.json temp_response.txt temp_headers.txt original_plugins.json repo_info.json temp_repo_info.json
    
    - name: Summary
      if: always()
      run: |
        if [ "${{ steps.fetch-data.outputs.should_update }}" = "true" ]; then
          if [ "${{ steps.git-check.outputs.has_changes }}" = "true" ]; then
            echo "âœ… æ’ä»¶æ•°æ®å·²æˆåŠŸè½¬æ¢å¹¶æäº¤"
          else
            echo "â„¹ï¸ æ•°æ®è·å–å’Œè½¬æ¢æˆåŠŸï¼Œä½†å†…å®¹æœªå‘ç”Ÿå˜åŒ–"
          fi
        else
          echo "âŒ ç”±äºç½‘ç»œé—®é¢˜ã€GitHubæœåŠ¡é”™è¯¯æˆ–æ•°æ®å¼‚å¸¸ï¼Œè·³è¿‡äº†æ•°æ®è½¬æ¢"
          echo "è¯·æ£€æŸ¥GitHubæœåŠ¡çŠ¶æ€æˆ–æŸ¥çœ‹ä¸Šé¢çš„é”™è¯¯è¯¦æƒ…"
        fi
