name: Transform Plugin Data

on:
  schedule:
    # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  transform-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
    
    - name: Fetch original plugin data
      id: fetch-data
      run: |
        echo "å¼€å§‹è·å–åŸå§‹æ’ä»¶æ•°æ®..."
        
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨å“åº”å’ŒHTTPçŠ¶æ€ç 
        temp_response="temp_response.txt"
        temp_headers="temp_headers.txt"
        
        # è·å–GitHubåŸå§‹æ–‡ä»¶å†…å®¹
        github_url="https://raw.githubusercontent.com/AstrBotDevs/AstrBot_Plugins_Collection/main/plugins.json"
        
        # ä½¿ç”¨curlè·å–æ•°æ®ï¼ŒåŒæ—¶ä¿å­˜HTTPçŠ¶æ€ç å’Œå“åº”å¤´
        http_code=$(curl -s --max-time 30 --retry 3 --retry-delay 5 \
          -H "User-Agent: GitHub-Action-Plugin-Transformer" \
          -H "Accept: application/json" \
          -w "%{http_code}" \
          -D "$temp_headers" \
          -o "$temp_response" \
          "$github_url")
        
        curl_exit_code=$?
        
        # æ£€æŸ¥curlå‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
        if [ $curl_exit_code -ne 0 ]; then
          echo "âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œcurlé€€å‡ºç : $curl_exit_code"
          case $curl_exit_code in
            6) echo "æ— æ³•è§£æä¸»æœºå" ;;
            7) echo "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨" ;;
            28) echo "è¯·æ±‚è¶…æ—¶" ;;
            35) echo "SSLè¿æ¥é”™è¯¯" ;;
            *) echo "å…¶ä»–ç½‘ç»œé”™è¯¯" ;;
          esac
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        echo "HTTPçŠ¶æ€ç : $http_code"
        
        # æ£€æŸ¥HTTPçŠ¶æ€ç 
        if [ "$http_code" -ne 200 ]; then
          echo "âŒ GitHubè¿”å›é200çŠ¶æ€ç : $http_code"
          case $http_code in
            404) echo "æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä»“åº“ä¸å¯è®¿é—® (404 Not Found)" ;;
            403) echo "è®¿é—®è¢«æ‹’ç»ï¼Œå¯èƒ½æ˜¯APIé™åˆ¶ (403 Forbidden)" ;;
            500) echo "GitHubæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (500 Internal Server Error)" ;;
            *) echo "HTTPé”™è¯¯çŠ¶æ€ç : $http_code" ;;
          esac
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # è¯»å–å“åº”å†…å®¹
        if [ ! -f "$temp_response" ]; then
          echo "âŒ å“åº”æ–‡ä»¶ä¸å­˜åœ¨"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        response=$(cat "$temp_response")
        
        # æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºç©º
        if [ -z "$response" ] || [ "$response" = "" ]; then
          echo "âŒ è·å–åˆ°çš„å“åº”ä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # æ£€æŸ¥å“åº”å¤§å°
        response_size=$(wc -c < "$temp_response")
        if [ "$response_size" -lt 50 ]; then
          echo "âŒ å“åº”å†…å®¹è¿‡å° ($response_size å­—èŠ‚)ï¼Œå¯èƒ½æ˜¯é”™è¯¯å“åº”"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSON
        if ! echo "$response" | jq . > /dev/null 2>&1; then
          echo "âŒ å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # æ£€æŸ¥JSONæ˜¯å¦ä¸ºç©ºå¯¹è±¡æˆ–ç©ºæ•°ç»„
        if [ "$response" = "{}" ] || [ "$response" = "[]" ] || [ "$response" = "null" ]; then
          echo "âŒ è·å–åˆ°ç©ºçš„JSONæ•°æ®ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # ä¿å­˜åŸå§‹æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶
        echo "$response" > original_plugins.json
        echo "should_update=true" >> $GITHUB_OUTPUT
        echo "âœ… æˆåŠŸè·å–åŸå§‹æ’ä»¶æ•°æ® ($response_size å­—èŠ‚)"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f "$temp_response" "$temp_headers"
    
    - name: Load existing cache for fallback
      if: steps.fetch-data.outputs.should_update == 'true'
      id: load-cache
      run: |
        echo "æ£€æŸ¥ç°æœ‰ç¼“å­˜æ–‡ä»¶..."
        if [ -f plugin_cache.json ]; then
          echo "å‘ç°ç°æœ‰ç¼“å­˜æ–‡ä»¶ï¼Œå°†ç”¨ä½œå›é€€æ•°æ®"
          cp plugin_cache.json existing_cache.json
          echo "has_existing_cache=true" >> $GITHUB_OUTPUT
        else
          echo "æ²¡æœ‰ç°æœ‰ç¼“å­˜æ–‡ä»¶"
          echo "has_existing_cache=false" >> $GITHUB_OUTPUT
        fi

    - name: Get GitHub API info for repositories
      if: steps.fetch-data.outputs.should_update == 'true'
      id: get-repo-info
      run: |
        echo "å¼€å§‹è·å–ä»“åº“ä¿¡æ¯..."
        
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å­˜å‚¨ä»“åº“ä¿¡æ¯
        echo "{}" > repo_info.json
        
        # åˆå§‹åŒ–ç»Ÿè®¡è®¡æ•°å™¨
        total_repos=0
        success_count=0
        failed_count=0
        deleted_count=0
        network_error_count=0
        
        # ä»åŸå§‹æ•°æ®ä¸­æå–æ‰€æœ‰ä»“åº“URL
        jq -r 'to_entries[] | .value.repo // empty' original_plugins.json | while read -r repo_url; do
          # æå–GitHubç”¨æˆ·åå’Œä»“åº“å (æ ¼å¼: https://github.com/user/repo)
          if [[ "$repo_url" =~ https://github\.com/([^/]+)/([^/]+) ]]; then
            owner="${BASH_REMATCH[1]}"
            repo="${BASH_REMATCH[2]}"
            total_repos=$((total_repos + 1))
            
            echo "[$total_repos] è·å–ä»“åº“ä¿¡æ¯: $owner/$repo"
            
            # è°ƒç”¨GitHub APIè·å–ä»“åº“ä¿¡æ¯ï¼Œå¢åŠ é‡è¯•æœºåˆ¶
            api_response=""
            http_code=""
            retry_count=0
            max_retries=3
            
            while [ $retry_count -lt $max_retries ]; do
              api_response=$(curl -s --max-time 15 --retry 2 --retry-delay 2 \
                -H "Accept: application/vnd.github.v3+json" \
                -H "User-Agent: GitHub-Action-Plugin-Transformer" \
                -w "HTTPSTATUS:%{http_code}" \
                "https://api.github.com/repos/$owner/$repo" 2>/dev/null || echo "CURL_ERROR")
              
              if [[ "$api_response" != "CURL_ERROR" ]]; then
                # åˆ†ç¦»HTTPçŠ¶æ€ç å’Œå“åº”ä½“
                http_code=$(echo "$api_response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
                api_response=$(echo "$api_response" | sed 's/HTTPSTATUS:[0-9]*$//')
                break
              fi
              
              retry_count=$((retry_count + 1))
              echo "  é‡è¯• $retry_count/$max_retries..."
              sleep 2
            done
            
            # å¤„ç†ä¸åŒçš„å“åº”æƒ…å†µ
            stars=0
            updated_at=""
            version=""
            status="unknown"
            
            if [[ "$api_response" == "CURL_ERROR" ]]; then
              echo "  âŒ ç½‘ç»œé”™è¯¯: æ— æ³•è¿æ¥åˆ°GitHub API"
              network_error_count=$((network_error_count + 1))
              status="network_error"
              
            elif [ "$http_code" = "404" ]; then
              echo "  ğŸ—‘ï¸  ä»“åº“å·²åˆ é™¤æˆ–ä¸å¯è®¿é—® (404)"
              deleted_count=$((deleted_count + 1))
              status="deleted"
              
            elif [ "$http_code" = "403" ]; then
              echo "  âš ï¸  APIé™åˆ¶æˆ–è®¿é—®è¢«æ‹’ç» (403)"
              failed_count=$((failed_count + 1))
              status="api_limit"
              
            elif [ "$http_code" = "200" ] && echo "$api_response" | jq -e '.stargazers_count' > /dev/null 2>&1; then
              # æˆåŠŸè·å–ä»“åº“ä¿¡æ¯
              stars=$(echo "$api_response" | jq -r '.stargazers_count // 0')
              updated_at=$(echo "$api_response" | jq -r '.updated_at // ""')
              success_count=$((success_count + 1))
              status="success"
              
              echo "  âœ… æˆåŠŸ - Stars: $stars, æ›´æ–°æ—¶é—´: $updated_at"
              
              # è·å–æœ€æ–°çš„releaseç‰ˆæœ¬ï¼ˆå¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼‰
              release_response=$(curl -s --max-time 10 \
                -H "Accept: application/vnd.github.v3+json" \
                -H "User-Agent: GitHub-Action-Plugin-Transformer" \
                "https://api.github.com/repos/$owner/$repo/releases/latest" 2>/dev/null || echo "{}")
              
              if echo "$release_response" | jq -e '.tag_name' > /dev/null 2>&1; then
                version=$(echo "$release_response" | jq -r '.tag_name')
              fi
              
            else
              echo "  âŒ æœªçŸ¥é”™è¯¯ (HTTP: $http_code)"
              failed_count=$((failed_count + 1))
              status="unknown_error"
            fi
            
            # å¦‚æœæœ‰ç°æœ‰ç¼“å­˜ï¼Œå°è¯•ä»ç¼“å­˜ä¸­è·å–å›é€€æ•°æ®
            if [ "$status" != "success" ] && [ "${{ steps.load-cache.outputs.has_existing_cache }}" = "true" ]; then
              cached_data=$(jq -r --arg url "$repo_url" '.data // {} | to_entries[] | select(.value.repo == $url) | .value | {stars: .stars, updated_at: .updated_at, version: .version}' existing_cache.json 2>/dev/null || echo "{}")
              
              if [ "$cached_data" != "{}" ] && [ "$cached_data" != "" ]; then
                cached_stars=$(echo "$cached_data" | jq -r '.stars // 0')
                cached_updated=$(echo "$cached_data" | jq -r '.updated_at // ""')
                cached_version=$(echo "$cached_data" | jq -r '.version // ""')
                
                if [ "$cached_stars" != "0" ] || [ "$cached_updated" != "" ]; then
                  echo "  ğŸ”„ ä½¿ç”¨ç¼“å­˜æ•°æ®: Stars: $cached_stars"
                  stars="$cached_stars"
                  updated_at="$cached_updated"
                  version="$cached_version"
                  status="cached"
                fi
              fi
            fi
            
            # å°†ä¿¡æ¯æ·»åŠ åˆ°repo_info.json
            jq --arg url "$repo_url" \
               --arg stars "$stars" \
               --arg updated "$updated_at" \
               --arg version "$version" \
               --arg status "$status" \
               '. + {($url): {stars: ($stars | tonumber), updated_at: $updated, version: $version, status: $status}}' \
               repo_info.json > temp_repo_info.json && mv temp_repo_info.json repo_info.json
            
            # æ·»åŠ å»¶è¿Ÿé¿å…APIé™åˆ¶
            sleep 1.5
          fi
        done
        
        echo ""
        echo "ğŸ“Š ä»“åº“ä¿¡æ¯è·å–ç»Ÿè®¡:"
        echo "  æ€»è®¡: $total_repos ä¸ªä»“åº“"
        echo "  âœ… æˆåŠŸ: $success_count"
        echo "  ğŸ”„ ä½¿ç”¨ç¼“å­˜: $(jq '[.[] | select(.status == "cached")] | length' repo_info.json)"
        echo "  ğŸ—‘ï¸  å·²åˆ é™¤: $deleted_count"
        echo "  ğŸŒ ç½‘ç»œé”™è¯¯: $network_error_count"
        echo "  âŒ å…¶ä»–å¤±è´¥: $failed_count"
        echo ""
        
        # å¦‚æœå¤§éƒ¨åˆ†ä»“åº“éƒ½å¤±è´¥äº†ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜
        if [ $total_repos -gt 0 ] && [ $((success_count * 100 / total_repos)) -lt 30 ]; then
          echo "âš ï¸  è­¦å‘Š: æˆåŠŸç‡è¿‡ä½ ($((success_count * 100 / total_repos))%)ï¼Œå¯èƒ½å­˜åœ¨ç½‘ç»œé—®é¢˜"
          if [ "${{ steps.load-cache.outputs.has_existing_cache }}" = "true" ]; then
            echo "å°†ä¸»è¦ä¾èµ–ç°æœ‰ç¼“å­˜æ•°æ®"
          fi
        fi
        
        echo "âœ… ä»“åº“ä¿¡æ¯è·å–å®Œæˆ"
    
    - name: Transform plugin data
      if: steps.fetch-data.outputs.should_update == 'true'
      run: |
        echo "å¼€å§‹è½¬æ¢æ’ä»¶æ•°æ®æ ¼å¼..."
        
        # ä½¿ç”¨jqè½¬æ¢æ•°æ®æ ¼å¼ï¼Œå¢åŠ å®¹é”™å¤„ç†
        jq --slurpfile repo_info repo_info.json '
        {
          data: (
            to_entries | map({
              key: .key,
              value: (
                .value + {
                  # ä¿æŒåŸæœ‰å­—æ®µ
                  desc: .value.desc,
                  author: .value.author,
                  repo: .value.repo,
                  tags: (.value.tags // []),
                  social_link: .value.social_link
                } + 
                # æ·»åŠ æ–°å­—æ®µï¼Œä»repo_infoä¸­è·å–
                (if .value.repo and ($repo_info[0][.value.repo]) then
                  ($repo_info[0][.value.repo] | {
                    stars: .stars,
                    updated_at: .updated_at,
                    version: (if .version != "" then .version else "1.0.0" end),
                    # æ·»åŠ çŠ¶æ€æ ‡è¯†ç”¨äºè°ƒè¯•ï¼ˆå¯é€‰ï¼‰
                    # repo_status: .status
                  })
                else
                  {
                    stars: 0,
                    version: "1.0.0"
                  }
                end)
              )
            }) | from_entries
          ),
          # æ·»åŠ å…ƒæ•°æ®
          meta: {
            last_updated: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
            total_plugins: (. | keys | length),
            source: "https://raw.githubusercontent.com/AstrBotDevs/AstrBot_Plugins_Collection/main/plugins.json"
          }
        }' original_plugins.json > temp_plugin_cache.json
        
        # æ ¼å¼åŒ–JSONä½¿å…¶æ›´æ˜“è¯»
        jq . temp_plugin_cache.json > plugin_cache_orginal.json
        
        echo "âœ… æ•°æ®è½¬æ¢å®Œæˆ"
        
        # æ˜¾ç¤ºè½¬æ¢ç»Ÿè®¡
        original_count=$(jq 'keys | length' original_plugins.json)
        new_count=$(jq '.data | keys | length' plugin_cache.json)
        
        # ç»Ÿè®¡ä¸åŒçŠ¶æ€çš„ä»“åº“
        success_repos=$(jq '[.[] | select(.status == "success")] | length' repo_info.json)
        cached_repos=$(jq '[.[] | select(.status == "cached")] | length' repo_info.json)
        deleted_repos=$(jq '[.[] | select(.status == "deleted")] | length' repo_info.json)
        failed_repos=$(jq '[.[] | select(.status != "success" and .status != "cached")] | length' repo_info.json)
        
        echo ""
        echo "ğŸ“Š è½¬æ¢ç»Ÿè®¡:"
        echo "  æ’ä»¶æ•°é‡: $original_count -> $new_count"
        echo "  âœ… å®æ—¶æ•°æ®: $success_repos ä¸ªä»“åº“"
        echo "  ğŸ”„ ç¼“å­˜æ•°æ®: $cached_repos ä¸ªä»“åº“"
        echo "  ğŸ—‘ï¸  å·²åˆ é™¤: $deleted_repos ä¸ªä»“åº“"
        echo "  âŒ æ— æ•°æ®: $failed_repos ä¸ªä»“åº“"
        
        # åˆ—å‡ºå·²åˆ é™¤çš„ä»“åº“
        if [ "$deleted_repos" -gt 0 ]; then
          echo ""
          echo "ğŸ—‘ï¸  å·²åˆ é™¤çš„ä»“åº“åˆ—è¡¨:"
          jq -r 'to_entries[] | select(.value.status == "deleted") | "  - " + .key' repo_info.json
        fi
        
        # åˆ—å‡ºå®Œå…¨å¤±è´¥çš„ä»“åº“
        if [ "$failed_repos" -gt 0 ]; then
          echo ""
          echo "âŒ æ— æ³•è·å–æ•°æ®çš„ä»“åº“:"
          jq -r 'to_entries[] | select(.value.status != "success" and .value.status != "cached" and .value.status != "deleted") | "  - " + .key + " (" + .value.status + ")"' repo_info.json
        fi
    
    - name: Check for changes
      if: steps.fetch-data.outputs.should_update == 'true'
      id: git-check
      run: |
        if [ -f plugin_cache.json ]; then
          git diff --exit-code plugin_cache.json || echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.fetch-data.outputs.should_update == 'true' && steps.git-check.outputs.has_changes == 'true'
      run: |
        git config --local user.email "igcrystalcache@gmail.com"
        git config --local user.name "IGCrystal-Ghost"
        
        git add plugin_cache.json
        git commit -m "ğŸ”„ Update transformed plugin cache - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        git push
        
        echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ–°åˆ°mainåˆ†æ”¯"
    
    - name: Clean up
      if: always()
      run: |
        # æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
        rm -f temp_plugin_cache.json temp_response.txt temp_headers.txt original_plugins.json repo_info.json temp_repo_info.json existing_cache.json
    
    - name: Summary
      if: always()
      run: |
        if [ "${{ steps.fetch-data.outputs.should_update }}" = "true" ]; then
          if [ "${{ steps.git-check.outputs.has_changes }}" = "true" ]; then
            echo "âœ… æ’ä»¶æ•°æ®å·²æˆåŠŸè½¬æ¢å¹¶æäº¤"
            
            # æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
            if [ -f plugin_cache.json ]; then
              total_plugins=$(jq '.data | keys | length' plugin_cache.json)
              echo "ğŸ“Š æœ€ç»ˆç»“æœ: $total_plugins ä¸ªæ’ä»¶å·²æ›´æ–°"
            fi
          else
            echo "â„¹ï¸ æ•°æ®è·å–å’Œè½¬æ¢æˆåŠŸï¼Œä½†å†…å®¹æœªå‘ç”Ÿå˜åŒ–"
          fi
        else
          echo "âŒ ç”±äºç½‘ç»œé—®é¢˜ã€GitHubæœåŠ¡é”™è¯¯æˆ–æ•°æ®å¼‚å¸¸ï¼Œè·³è¿‡äº†æ•°æ®è½¬æ¢"
          echo "è¯·æ£€æŸ¥GitHubæœåŠ¡çŠ¶æ€æˆ–æŸ¥çœ‹ä¸Šé¢çš„é”™è¯¯è¯¦æƒ…"
        fi
        
        echo ""
        echo "ğŸ’¡ å®¹é”™æœºåˆ¶è¯´æ˜:"
        echo "  - åˆ åº“/404: ç»§ç»­å¤„ç†å…¶ä»–ä»“åº“ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰"
        echo "  - ç½‘ç»œé”™è¯¯: è‡ªåŠ¨é‡è¯•3æ¬¡ï¼Œå¤±è´¥åä½¿ç”¨ç¼“å­˜æ•°æ®"
        echo "  - APIé™åˆ¶: ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œå»¶é•¿è¯·æ±‚é—´éš”"
        echo "  - æˆåŠŸç‡ä½: ä¸»è¦ä¾èµ–ç°æœ‰ç¼“å­˜ï¼Œç¡®ä¿æœåŠ¡ç¨³å®šæ€§"
